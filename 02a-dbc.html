<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="generator" content="pandoc">
    <title>Software Carpentry: Testing</title>
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="css/swc.css" />
    <link rel="alternate" type="application/rss+xml" title="Software Carpentry Blog" href="http://software-carpentry.org/feed.xml"/>
    <meta charset="UTF-8" />
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body class="lesson">
    <div class="container card">
      <div class="banner">
        <a href="http://software-carpentry.org" title="Software Carpentry">
          <img alt="Software Carpentry banner" src="img/software-carpentry-banner.png" />
        </a>
      </div>
      <article>
      <div class="row">
        <div class="col-md-10 col-md-offset-1">
                    <a href="index.html"><h1 class="title">Testing</h1></a>
          <h2 class="subtitle">Design by Contract</h2>
          <section class="objectives panel panel-warning">
<div class="panel-heading">
<h2 id="learning-objectives"><span class="glyphicon glyphicon-certificate"></span>Learning Objectives</h2>
</div>
<div class="panel-body">
<ul>
<li>Design by Contract is a way of using Assertions for interface specification.</li>
<li>Design by Contract defines pre-, post- and invariant conditions a function and a caller agree to obey.</li>
</ul>
</div>
</section>
<p>In <a href="https://en.wikipedia.org/wiki/Design_by_contract">Design by Contract</a>, the interaction between a caller and a library is treated as being governed by a <em>contract</em>. A contract involves three different types of requirements.</p>
<ul>
<li>Pre-conditions: Things that must be true before calling the function.</li>
<li>Post-conditions: Things that are guaranteed to be true after the function returns.</li>
<li>Invariant-conditions: Things that are guaranteed not to change during the function’s execution (e.g. side effects)</li>
</ul>
<p><strong>NOTE</strong>: In Python’s contracts, only pre- and post-conditions are handled.</p>
<p>To demonstrate the use of contracts, in the example here, we implement our own version of an integer square root function for perfect squares, called psqrt. We define a contract that indicates the caller is required to pass an integer value greater than or equal to zero. This is an example of a pre-condition. Next, the function will return an integer greater than or equal to zero. This is an example of a post-condition. The contract is defined using Python <a href="https://www.python.org/dev/peps/pep-0318">decorator</a> notation.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">from</span> math <span class="im">import</span> sqrt
<span class="im">from</span> contracts <span class="im">import</span> contract

<span class="at">@contract</span>(x<span class="op">=</span><span class="st">&#39;int,&gt;=0&#39;</span>,returns<span class="op">=</span><span class="st">&#39;int,&gt;=0&#39;</span>)
<span class="kw">def</span> psqrt(x):
    <span class="cf">return</span> <span class="bu">int</span>(sqrt(x))

<span class="bu">print</span> <span class="st">&quot;Square root of perfect square 4 = </span><span class="sc">%d</span><span class="st">&quot;</span><span class="op">%</span>psqrt(<span class="dv">4</span>)</code></pre></div>
<pre class="output"><code>Square root of perfect square 4 = 2</code></pre>
<p>Here the caller and the function obey the contract and the function call proceeds as expected. Next, let’s see what happens when we pass a negative value to the funciton.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="bu">print</span> <span class="st">&quot;Square root of perfect square -4 = </span><span class="sc">%d</span><span class="st">&quot;</span><span class="op">%</span>psqrt(<span class="op">-</span><span class="dv">4</span>)</code></pre></div>
<pre class="output"><code>Traceback (most recent call last):
  File &quot;../foo.py&quot;, line 9, in &lt;module&gt;
    print &quot;Square root of perfect square -4 = %d&quot;%psqrt(-4)
  File &quot;&lt;decorator-gen-1&gt;&quot;, line 2, in psqrt
  File &quot;/Library/Python/2.7/site-packages/PyContracts-1.7.15-py2.7.egg/contracts/main.py&quot;, line 253, in contracts_checker
    raise e
contracts.interface.ContractNotRespected: Breach for argument &#39;x&#39; to psqrt().
Condition -4 &gt;= 0 not respected
checking: &gt;=0       for value: Instance of &lt;type &#39;int&#39;&gt;: -4   
checking: int,&gt;=0   for value: Instance of &lt;type &#39;int&#39;&gt;: -4   
Variables bound in inner context:</code></pre>
<p>Here, an exception is raised and some additional details indicating which condition of the contract was violated.</p>
<h3 id="extending-contracts">Extending Contracts</h3>
<p>Sometimes, the simple syntax for defining contracts is not sufficient. In this case, contracts can be extended by defining a function that implements a new contract. For example, number theory tells us that all perfect squares end in a digit of 1,4,5,6, or 9 or end in an even number of zero digits. We can define a new contract that checks this condition</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="at">@new_contract</span>
<span class="kw">def</span> endsOk(x):
    ends14569 <span class="op">=</span> x<span class="op">%</span><span class="dv">10</span> <span class="kw">in</span> (<span class="dv">1</span>,<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">9</span>)
    ends00 <span class="op">=</span> <span class="bu">int</span>(<span class="bu">round</span>((log(x,<span class="dv">10</span>)))) <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">0</span>
    <span class="cf">if</span> ends14569 <span class="kw">or</span> ends00:
        <span class="cf">return</span> <span class="va">True</span>
    <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">&quot;</span><span class="sc">%s</span><span class="st"> doesn&#39;t end in 1,4,5,6 or 9 or even number of zeros&quot;</span><span class="op">%</span>x)</code></pre></div>
<p>We can then use this function, <em>endsOk</em>, in a contract specification</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="at">@contract</span>(x<span class="op">=</span><span class="st">&#39;int,endsOk,&gt;=0&#39;</span>,returns<span class="op">=</span><span class="st">&#39;int,&gt;=0&#39;</span>)
<span class="kw">def</span> psqrt2(x):
    <span class="cf">return</span> <span class="bu">int</span>(sqrt(x))</code></pre></div>
<p>Let’s see what happens when we try to use this <em>psqrt2</em> function on a number that ends in an odd number of zeros.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="bu">print</span> <span class="st">&quot;Perfect square root of 1000 = </span><span class="sc">%d</span><span class="st">&quot;</span><span class="op">%</span>psqrt2(<span class="dv">1000</span>)</code></pre></div>
<pre class="output"><code>Traceback (most recent call last):
  File &quot;../foo.py&quot;, line 24, in &lt;module&gt;
    print &quot;Perfect square root of 1000 = %d&quot;%psqrt2(1000)
  File &quot;&lt;decorator-gen-3&gt;&quot;, line 2, in psqrt2
  File &quot;/Library/Python/2.7/site-packages/PyContracts-1.7.15-py2.7.egg/contracts/main.py&quot;, line 253, in contracts_checker
    raise e
contracts.interface.ContractNotRespected: Breach for argument &#39;x&#39; to psqrt2().
1000 doesn&#39;t end in 1,4,5,6 or 9 or even number of zeros
checking: callable()       for value: Instance of &lt;type &#39;int&#39;&gt;: 1000   
checking: endsOk           for value: Instance of &lt;type &#39;int&#39;&gt;: 1000   
checking: int,endsOk,&gt;=0   for value: Instance of &lt;type &#39;int&#39;&gt;: 1000   
Variables bound in inner context:</code></pre>
<h3 id="performance-considerations">Performance Considerations</h3>
<p>Depending on the situation, checking validity of a contract can be expensive. For example, suppose a function is designed to perform a binary search on a sorted list of numbers. A pre-condition for the operation is that the list it is given to search is sorted. If the list is large, checking that it is properly sorted is expensive. In other words, contracts can impact performance. This means it is desirable to have a way to disable contract checks. This can be accomplished either by setting an environment variable, DISABLE_CONTRACTS or by a call to contracts.disable_all() <strong>before</strong> any <span class="citation">@contracts</span> are processed by the Python interpreter.</p>
<p><a href="https://andreacensi.github.io/contracts/index.html#">Learn more about Design by Contract in Python</a></p>
        </div>
      </div>
      </article>
      <div class="footer">
        <a class="label swc-blue-bg" href="http://software-carpentry.org">Software Carpentry</a>
        <a class="label swc-blue-bg" href="https://github.com/swcarpentry/lesson-template">Source</a>
        <a class="label swc-blue-bg" href="mailto:admin@software-carpentry.org">Contact</a>
        <a class="label swc-blue-bg" href="LICENSE.html">License</a>
      </div>
    </div>
    <!-- Javascript placed at the end of the document so the pages load faster -->
    <script src="http://software-carpentry.org/v5/js/jquery-1.9.1.min.js"></script>
    <script src="css/bootstrap/bootstrap-js/bootstrap.js"></script>
  </body>
</html>
